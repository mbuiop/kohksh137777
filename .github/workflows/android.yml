name: ðŸŽ® Build Kohksh Heavy Game APK
on: 
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-heavy-game:
    name: ðŸ—ï¸ Build Heavy Game APK
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    # Ù…Ø±Ø­Ù„Ù‡ 1: Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸ› ï¸ Setup Android Environment
      uses: android-actions/setup-android@v3
      
    # Ù…Ø±Ø­Ù„Ù‡ 2: Ø§ÛŒØ¬Ø§Ø¯ Ù¾Ø±ÙˆÚ˜Ù‡
    - name: ðŸŽ¯ Create Android Project
      run: |
        echo "ðŸš€ Creating Android project for Kohksh Heavy Game..."
        
        # Ø§ÛŒØ¬Ø§Ø¯ Ø³Ø§Ø®ØªØ§Ø± Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§
        mkdir -p app/src/main/java/com/kohksh/heavygame/
        mkdir -p app/src/main/cpp/
        mkdir -p app/src/main/res/values/
        mkdir -p app/src/main/jniLibs/arm64-v8a/
        
        # Ú©Ù¾ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ
        echo "ðŸ“¦ Copying game files..."
        if [ -f "Main.cpp" ]; then
          cp "Main.cpp" app/src/main/cpp/main.cpp
          echo "âœ… Main.cpp copied"
        fi
        if [ -d "Engine" ]; then
          cp -r Engine/* app/src/main/cpp/ 2>/dev/null || true
          echo "âœ… Engine files copied"
        fi
        if [ -d "Game" ]; then
          cp -r Game/* app/src/main/cpp/ 2>/dev/null || true
          echo "âœ… Game files copied"
        fi
        if [ -f "SDL2.zip" ]; then
          unzip -q SDL2.zip -d sdl-extracted/
          find sdl-extracted/ -name "*.so" -exec cp {} app/src/main/jniLibs/arm64-v8a/ \; 2>/dev/null || true
          echo "âœ… SDL2 libraries copied"
        fi
        
        # Ø§ÛŒØ¬Ø§Ø¯ AndroidManifest.xml
        cat > app/src/main/AndroidManifest.xml << 'EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <manifest xmlns:android="http://schemas.android.com/apk/res/android"
            package="com.kohksh.heavygame">
            <uses-feature android:glEsVersion="0x00030000" android:required="true"/>
            <application android:label="Kohksh Heavy Game">
                <activity android:name=".MainActivity" android:exported="true"
                         android:screenOrientation="landscape">
                    <intent-filter>
                        <action android:name="android.intent.action.MAIN"/>
                        <category android:name="android.intent.category.LAUNCHER"/>
                    </intent-filter>
                </activity>
            </application>
        </manifest>
        EOF
        
        # Ø§ÛŒØ¬Ø§Ø¯ MainActivity.java
        cat > app/src/main/java/com/kohksh/heavygame/MainActivity.java << 'EOF'
        package com.kohksh.heavygame;
        import android.app.*;
        import android.os.*;
        public class MainActivity extends Activity {
            static { 
                System.loadLibrary("kohksh-heavy");
                System.loadLibrary("sdl2");
            }
            public native void startHeavyGame();
            @Override
            protected void onCreate(Bundle savedInstanceState) {
                super.onCreate(savedInstanceState);
                new Thread(() -> startHeavyGame()).start();
            }
        }
        EOF
        
        # Ø§ÛŒØ¬Ø§Ø¯ CMakeLists.txt
        cat > app/src/main/cpp/CMakeLists.txt << 'EOF'
        cmake_minimum_required(VERSION 3.18.1)
        project("kohksh-heavy")
        set(CMAKE_CXX_STANDARD 17)
        find_library(log-lib log)
        find_library(android-lib android)
        find_library(gles-lib GLESv2)
        file(GLOB GAME_SOURCES *.cpp)
        add_library(kohksh-heavy SHARED ${GAME_SOURCES})
        target_link_libraries(kohksh-heavy ${log-lib} ${android-lib} ${gles-lib})
        EOF
        
        # Ø§ÛŒØ¬Ø§Ø¯ build.gradle
        cat > app/build.gradle << 'EOF'
        plugins { id 'com.android.application' }
        android {
            compileSdk 34
            namespace 'com.kohksh.heavygame'
            defaultConfig {
                applicationId "com.kohksh.heavygame"
                minSdk 24
                targetSdk 34
                versionCode 1
                versionName "1.0"
                externalNativeBuild {
                    cmake { 
                        cppFlags '-std=c++17 -O2'
                        arguments "-DANDROID_STL=c++_shared"
                    }
                }
                ndk { abiFilters 'arm64-v8a' }
            }
            externalNativeBuild {
                cmake { path "src/main/cpp/CMakeLists.txt" }
            }
        }
        EOF
        
        echo "include ':app'" > settings.gradle
        
        # Ø§ÛŒØ¬Ø§Ø¯ gradlew
        cat > gradlew << 'EOF'
        #!/bin/sh
        echo "ðŸŽ® Building Kohksh Heavy Game..."
        exec gradle "$@"
        EOF
        chmod +x gradlew
        
    # Ù…Ø±Ø­Ù„Ù‡ 3: Ø³Ø§Ø®Øª APK
    - name: ðŸ—ï¸ Build APK
      run: |
        echo "ðŸ”¨ Building APK..."
        ./gradlew assembleDebug --stacktrace
        
    # Ù…Ø±Ø­Ù„Ù‡ 4: Ø¢Ù¾Ù„ÙˆØ¯ Ù†ØªÛŒØ¬Ù‡
    - name: ðŸ“± Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: kohksh-heavy-game
        path: app/build/outputs/apk/debug/app-debug.apk
        
    - name: ðŸŽ‰ Success Message
      if: success()
      run: echo "ðŸŽ‰ Kohksh Heavy Game APK built successfully!"
