name: ğŸ® Build Heavy Graphics Game
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: ğŸ“¥ Checkout Heavy Game
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0
        
    - name: ğŸ› ï¸ Setup Heavy Android Environment
      uses: android-actions/setup-android@v3
      with:
        api-level: 34
        build-tools: 34.0.0
        ndk: 25.1.8937393
        cmake: 3.22.1
        extra-sdk-components: |
          platforms;android-34
          build-tools;34.0.0
          ndk;25.1.8937393
          cmake;3.22.1
        
    - name: ğŸ¯ Process Heavy Game Files
      run: |
        echo "ğŸ® Processing Heavy Graphics Game..."
        
        # Ø§ÛŒØ¬Ø§Ø¯ Ø³Ø§Ø®ØªØ§Ø± Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²ÛŒ Ø³Ù†Ú¯ÛŒÙ†
        mkdir -p app/src/main/java/com/kohksh/heavy/
        mkdir -p app/src/main/cpp/
        mkdir -p app/src/main/jniLibs/arm64-v8a/
        
        # Ú©Ù¾ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ Ø³Ù†Ú¯ÛŒÙ†
        echo "ğŸ“¦ Copying heavy game files..."
        
        # ÙØ§ÛŒÙ„ Ø§ØµÙ„ÛŒ Ø¨Ø§Ø²ÛŒ
        if [ -f "Main.cpp" ]; then
          cp "Main.cpp" app/src/main/cpp/
          echo "âœ… Main.cpp copied"
        fi
        
        # Ù…ÙˆØªÙˆØ± Ø¨Ø§Ø²ÛŒ
        if [ -d "Engine" ]; then
          find "Engine" -name "*.cpp" -exec cp {} app/src/main/cpp/ \; 2>/dev/null || true
          find "Engine" -name "*.h" -exec cp {} app/src/main/cpp/ \; 2>/dev/null || true
          echo "âœ… Engine files copied"
        fi
        
        # ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ
        if [ -d "Game" ]; then
          find "Game" -name "*.cpp" -exec cp {} app/src/main/cpp/ \; 2>/dev/null || true
          find "Game" -name "*.h" -exec cp {} app/src/main/cpp/ \; 2>/dev/null || true
          echo "âœ… Game files copied"
        fi
        
        # Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ Ú¯Ø±Ø§ÙÛŒÚ©ÛŒ
        if [ -f "SDL2.zip" ]; then
          unzip -q "SDL2.zip" -d sdl-extracted/
          find sdl-extracted/ -name "*.so" -exec cp {} app/src/main/jniLibs/arm64-v8a/ \; 2>/dev/null || true
          echo "âœ… SDL2 libraries copied"
        fi
        
    - name: âš™ï¸ Create Heavy Game Project
      run: |
        # AndroidManifest Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²ÛŒ Ú¯Ø±Ø§ÙÛŒÚ©ÛŒ
        cat > app/src/main/AndroidManifest.xml << 'EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <manifest xmlns:android="http://schemas.android.com/apk/res/android"
            package="com.kohksh.heavy">
            <uses-feature android:glEsVersion="0x00030000" android:required="true"/>
            <application android:label="Kohksh Heavy Game">
                <activity android:name=".MainActivity" android:exported="true"
                         android:screenOrientation="landscape">
                    <intent-filter>
                        <action android:name="android.intent.action.MAIN"/>
                        <category android:name="android.intent.category.LAUNCHER"/>
                    </intent-filter>
                </activity>
            </application>
        </manifest>
        EOF
        
        # MainActivity Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²ÛŒ Ø³Ù†Ú¯ÛŒÙ†
        cat > app/src/main/java/com/kohksh/heavy/MainActivity.java << 'EOF'
        package com.kohksh.heavy;
        import android.app.*;
        import android.os.*;
        public class MainActivity extends Activity {
            static { 
                System.loadLibrary("kohksh-heavy");
                System.loadLibrary("sdl2");
            }
            public native void startHeavyGame();
            @Override
            protected void onCreate(Bundle savedInstanceState) {
                super.onCreate(savedInstanceState);
                new Thread(() -> startHeavyGame()).start();
            }
        }
        EOF
        
        # CMakeLists.txt Ø¨Ø±Ø§ÛŒ Ú©Ø§Ù…Ù¾Ø§ÛŒÙ„ C++ Ø³Ù†Ú¯ÛŒÙ†
        cat > app/src/main/cpp/CMakeLists.txt << 'EOF'
        cmake_minimum_required(VERSION 3.18.1)
        project("kohksh-heavy")
        set(CMAKE_CXX_STANDARD 17)
        find_library(log-lib log)
        find_library(android-lib android)
        find_library(gles-lib GLESv2)
        file(GLOB GAME_SOURCES *.cpp)
        add_library(kohksh-heavy SHARED ${GAME_SOURCES})
        target_link_libraries(kohksh-heavy ${log-lib} ${android-lib} ${gles-lib})
        EOF
        
        # build.gradle Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²ÛŒ Ø³Ù†Ú¯ÛŒÙ†
        cat > app/build.gradle << 'EOF'
        plugins { id 'com.android.application' }
        android {
            compileSdk 34
            namespace 'com.kohksh.heavy'
            defaultConfig {
                applicationId "com.kohksh.heavy"
                minSdk 24
                targetSdk 34
                versionCode 1
                versionName "1.0"
                externalNativeBuild {
                    cmake { 
                        cppFlags '-std=c++17 -O3'
                        arguments "-DANDROID_STL=c++_shared"
                    }
                }
                ndk { abiFilters 'arm64-v8a' }
            }
            externalNativeBuild {
                cmake { path "src/main/cpp/CMakeLists.txt" }
            }
        }
        EOF
        
        echo "include ':app'" > settings.gradle
        
    - name: ğŸ—ï¸ Build Heavy Game APK
      run: |
        echo "ğŸ—ï¸ Building Heavy Graphics Game APK..."
        chmod +x gradlew
        ./gradlew assembleDebug --stacktrace
        
    - name: ğŸ“± Upload Heavy Game APK
      uses: actions/upload-artifact@v4
      with:
        name: kohksh-heavy-game
        path: app/build/outputs/apk/debug/app-debug.apk
