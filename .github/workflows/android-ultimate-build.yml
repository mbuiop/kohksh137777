name: ðŸ”¥ Ultimate Android Build - Kohksh Heavy Game

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  ultimate-android-build:
    name: ðŸ—ï¸ Ultimate APK Build
    runs-on: ubuntu-latest
    timeout-minutes: 45

    env:
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
      JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64
      GRADLE_OPTS: -Xmx4g -Dfile.encoding=UTF-8

    steps:
    - name: ðŸ”„ Checkout Code with Full History
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive

    # ===============================
    #   FIXED & CLEAN ENVIRONMENT
    # ===============================
    - name: ðŸ› ï¸ Setup Ultimate Android Environment
      uses: android-actions/setup-android@v3
      with:
        accept-android-sdk-licenses: true
        packages: |
          platform-tools
          platforms;android-34
          build-tools;34.0.0
          ndk;25.1.8937393
          cmake;3.22.1

    # ===============================
    #   GRADLE / ANDROID CACHE
    # ===============================
    - name: ðŸ’¾ Setup Mega Caching System
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          ~/.android/build-cache
        key: ${{ runner.os }}-ultimate-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-ultimate-

    # ===============================
    #  PROCESS HEAVY ENGINE FILES
    # ===============================
    - name: ðŸ“¦ Process Heavy Game Assets & Code
      run: |
        set -e
        echo "ðŸŽ® Preparing Kohksh Ultimate Engine..."

        mkdir -p app/src/main/java/com/kohksh/ultimategame/
        mkdir -p app/src/main/cpp/core/
        mkdir -p app/src/main/cpp/game/
        mkdir -p app/src/main/cpp/utils/
        mkdir -p app/src/main/assets/textures/
        mkdir -p app/src/main/jniLibs/arm64-v8a/

        if [ -f "Main.cpp" ]; then
          cp Main.cpp app/src/main/cpp/core/main.cpp
        fi

        copy_files() {
          SRC=$1
          DEST=$2
          EXT=$3
          if [ -d "$SRC" ]; then
            find "$SRC" -name "*.$EXT" -exec cp --parents {} "$DEST" \; 2>/dev/null || true
          fi
        }

        copy_files Engine app/src/main/cpp/core cpp
        copy_files Engine app/src/main/cpp/core h
        copy_files Game app/src/main/cpp/game cpp

    # ===============================
    #   MANIFEST / JAVA
    # ===============================
    - name: âš™ï¸ Create AndroidManifest.xml
      run: |
        mkdir -p app/src/main/
        cat > app/src/main/AndroidManifest.xml << 'EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <manifest xmlns:android="http://schemas.android.com/apk/res/android"
            package="com.kohksh.ultimategame">

            <uses-permission android:name="android.permission.INTERNET"/>
            <uses-feature android:glEsVersion="0x00030002" android:required="true"/>

            <application
                android:label="@string/app_name_ultimate"
                android:theme="@style/UltimateAppTheme"
                android:hardwareAccelerated="true">

                <activity
                    android:name=".UltimateMainActivity"
                    android:exported="true"
                    android:screenOrientation="sensorLandscape">
                    <intent-filter>
                        <action android:name="android.intent.action.MAIN"/>
                        <category android:name="android.intent.category.LAUNCHER"/>
                    </intent-filter>
                </activity>
            </application>
        </manifest>
        EOF

    - name: ðŸ’» Create Ultimate Java Activity
      run: |
        mkdir -p app/src/main/java/com/kohksh/ultimategame/
        cat > app/src/main/java/com/kohksh/ultimategame/UltimateMainActivity.java << 'EOF'
        package com.kohksh.ultimategame;

        import android.app.Activity;
        import android.os.Bundle;
        import android.view.SurfaceView;
        import android.view.WindowManager;

        public class UltimateMainActivity extends Activity {

            static {
                System.loadLibrary("kohksh-ultimate-engine");
            }

            @Override
            protected void onCreate(Bundle savedInstanceState) {
                super.onCreate(savedInstanceState);
                getWindow().addFlags(WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON);
                SurfaceView view = new SurfaceView(this);
                setContentView(view);
            }
        }
        EOF

    # ===============================
    #   RESOURCES (STRINGS/STYLES)
    # ===============================
    - name: ðŸŽ¨ Create Resources
      run: |
        mkdir -p app/src/main/res/values/
        cat > app/src/main/res/values/strings.xml << 'EOF'
        <resources>
          <string name="app_name_ultimate">Kohksh Ultimate Game</string>
        </resources>
        EOF

        cat > app/src/main/res/values/styles.xml << 'EOF'
        <resources>
          <style name="UltimateAppTheme" parent="Theme.MaterialComponents.DayNight.NoActionBar"/>
        </resources>
        EOF

    # ===============================
    #        CMAKE & GRADLE
    # ===============================
    - name: ðŸ”§ Create CMakeLists.txt
      run: |
        mkdir -p app/src/main/cpp/
        cat > app/src/main/cpp/CMakeLists.txt << 'EOF'
        cmake_minimum_required(VERSION 3.18.1)
        project("kohksh-ultimate-engine")

        file(GLOB_RECURSE SRC_FILES "*.cpp" "*.c")

        add_library(kohksh-ultimate-engine SHARED ${SRC_FILES})

        find_library(log-lib log)

        target_link_libraries(kohksh-ultimate-engine ${log-lib})
        EOF

    - name: ðŸ“¦ Create Gradle Files
      run: |
        mkdir -p app/
        cat > app/build.gradle << 'EOF'
        plugins {
            id 'com.android.application'
        }

        android {
            namespace "com.kohksh.ultimategame"
            compileSdk 34

            defaultConfig {
                minSdk 24
                targetSdk 34
                versionCode 1
                versionName "3.0.0"

                externalNativeBuild {
                    cmake { cppFlags "-std=c++17" }
                }

                ndk { abiFilters "arm64-v8a" }
            }

            externalNativeBuild {
                cmake { path "src/main/cpp/CMakeLists.txt" }
            }
        }
        EOF

        echo "include ':app'" > settings.gradle

        cat > build.gradle << 'EOF'
        buildscript {
            repositories { google(); mavenCentral() }
            dependencies { classpath 'com.android.tools.build:gradle:8.0.0' }
        }

        allprojects {
            repositories { google(); mavenCentral() }
        }
        EOF

    # ===============================
    #           BUILD
    # ===============================
    - name: ðŸ—ï¸ Build Ultimate APK
      run: |
        chmod +x gradlew
        ./gradlew clean assembleDebug --no-daemon --stacktrace

    - name: ðŸ“± Upload Ultimate APK
      uses: actions/upload-artifact@v4
      with:
        name: kohksh-ultimate-game
        path: app/build/outputs/apk/debug/app-debug.apk
